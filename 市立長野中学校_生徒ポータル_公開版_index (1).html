<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>市立長野中学校 生徒ポータル（公開版）</title>
<style>
  :root{--brand:#1e3a8a;--accent:#2563eb;--muted:#64748b;--bg:#f3f8ff}
  body{font-family:"Meiryo","Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);margin:0;padding:18px;color:#0b1220}
  .wrap{max-width:980px;margin:0 auto}
  header{background:linear-gradient(90deg,var(--brand),var(--accent));color:#fff;padding:20px;border-radius:10px;text-align:center}
  header h1{margin:0;font-size:1.4rem}
  main{background:#fff;border-radius:12px;padding:18px;margin-top:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  h2{color:var(--brand);margin:8px 0}
  p{margin:8px 0}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc;background:#fbfdff;margin-top:8px}
  button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #e6eefc;color:var(--brand)}
  .muted{color:var(--muted);font-size:0.95rem}
  .card{background:#fff;padding:12px;border-radius:10px;margin-top:12px;border:1px solid #f0f8ff}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .notes .note{border-bottom:1px dashed #eef6ff;padding:8px 0}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:0.9rem}
  pre{background:#f7fbff;padding:10px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>市立長野中学校 生徒ポータル（公開版・試作）</h1>
  </header>

  <main>
    <section class="card">
      <h2>このサイトの目的</h2>
      <p class="muted">生徒が学習メモや振り返りを記録して、自分の学習を振り返るためのポータルです。試作段階のため、公開前に必ず学校（担当教員）へ承認を得てください。</p>
    </section>

    <section id="authCard" class="card">
      <h2>ログイン / 新規登録</h2>
      <p class="muted">学校の許可が出ている場合のみ登録してください。テストでは個人情報は入力しないでください。</p>
      <input id="email" type="email" placeholder="メールアドレス（例：taro@school.jp）" />
      <input id="password" type="password" placeholder="パスワード（6文字以上）" />
      <div class="flex" style="margin-top:10px">
        <button id="btnSignup">新規登録</button>
        <button id="btnLogin" class="ghost">ログイン</button>
        <button id="btnGuest" class="ghost">テスト（ゲスト）</button>
      </div>
      <p class="muted" style="margin-top:10px">※ 登録後はウェルカム画面が表示されます。問題があれば担任に連絡してください。</p>
    </section>

    <section id="appCard" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>自分の学習メモ</h2>
        <div class="flex">
          <div class="muted small">ログイン中: <strong id="userEmail">-</strong></div>
          <button id="btnSignout" class="ghost">サインアウト</button>
        </div>
      </div>

      <p class="muted">今日やったこと、わからなかったこと、次にやることなどを保存してください。保存したメモはあなた自身だけが見られます（学校の運用により先生が確認する場合あり）。</p>
      <textarea id="noteText" rows="6" placeholder="例：英語の単語練習30分。間違えた単語を5つメモ。"></textarea>
      <div class="flex" style="margin-top:8px">
        <button id="btnSave">保存</button>
        <button id="btnLoad" class="ghost">一覧表示</button>
        <button id="btnExport" class="ghost">CSVダウンロード（自分用）</button>
      </div>

      <div id="notesList" class="notes" style="margin-top:12px"></div>
    </section>

    <section class="card">
      <h3>先生・管理者向け（必ずお読みください）</h3>
      <p class="muted">公開前に以下を必ず実施してください。</p>
      <ol class="muted">
        <li>Firebase コンソールで Authentication の「Email/Password」を有効にする。</li>
        <li>Firestore のセキュリティルールを設定し、公開モードのままにしないこと（下のルール例を使用）。</li>
        <li>試験運用中は利用状況を監視し、必要であれば Blaze（従量課金）へ切替。</li>
      </ol>

      <h4>Firestore ルール（コピーして貼ってください）</h4>
      <pre class="muted">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /notes/{noteId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.uid == request.auth.uid;
    }
  }
}
      </pre>
    </section>
  </main>

  <footer>市立長野中学校 生徒ポータル（試作） — 生徒会 / 作成チーム。公開は担当教員の承認が必要です。</footer>
</div>

<!-- Firebase (CDN modular) 初期化 + アプリ機能 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // --- あなたの Firebase 設定（そのまま貼り付け済み） ---
  const firebaseConfig = {
    apiKey: "AIzaSyDhw2AZw8dq1DwywWExyw4bNaf-8qdWq7w",
    authDomain: "ichinaga-school-portal.firebaseapp.com",
    projectId: "ichinaga-school-portal",
    storageBucket: "ichinaga-school-portal.firebasestorage.app",
    messagingSenderId: "79417995177",
    appId: "1:79417995177:web:a76c19055e0709051c5eb8"
  };

  // 初期化
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI Elements
  const emailInput = document.getElementById('email');
  const pwInput = document.getElementById('password');
  const btnSignup = document.getElementById('btnSignup');
  const btnLogin = document.getElementById('btnLogin');
  const btnGuest = document.getElementById('btnGuest');
  const authCard = document.getElementById('authCard');
  const appCard = document.getElementById('appCard');
  const btnSignout = document.getElementById('btnSignout');
  const userEmail = document.getElementById('userEmail');
  const noteText = document.getElementById('noteText');
  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const notesList = document.getElementById('notesList');
  const btnExport = document.getElementById('btnExport');

  // 認証状態監視
  onAuthStateChanged(auth, user => {
    if (user) {
      authCard.style.display = 'none';
      appCard.style.display = 'block';
      userEmail.textContent = user.email || '(不明)';
      loadNotes();
    } else {
      authCard.style.display = 'block';
      appCard.style.display = 'none';
      userEmail.textContent = '-';
    }
  });

  // 新規登録
  btnSignup.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const pw = pwInput.value;
    if (!email || pw.length < 6) return alert('メールと6文字以上のパスワードを入力してください');
    try {
      await createUserWithEmailAndPassword(auth, email, pw);
      alert('登録完了しました。ログインしてメモを保存できます。');
    } catch (e) {
      console.error(e);
      alert('登録エラー: ' + e.message);
    }
  });

  // ログイン
  btnLogin.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const pw = pwInput.value;
    if (!email || !pw) return alert('入力してください');
    try {
      await signInWithEmailAndPassword(auth, email, pw);
    } catch (e) {
      console.error(e);
      alert('ログイン失敗: ' + e.message);
    }
  });

  // ゲスト（ローカル表示のみ）
  btnGuest.addEventListener('click', () => {
    alert('ゲストモード：データは保存されません。見た目のテスト用です。');
    authCard.style.display = 'none';
    appCard.style.display = 'block';
    userEmail.textContent = 'ゲスト';
  });

  // サインアウト
  btnSignout.addEventListener('click', () => signOut(auth));

  // 保存
  btnSave.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert('ログインしてください');
    const content = noteText.value.trim();
    if (!content) return alert('メモを入力してください');
    try {
      await addDoc(collection(db, 'notes'), {
        uid: user.uid,
        email: user.email || null,
        content,
        createdAt: serverTimestamp()
      });
      noteText.value = '';
      alert('保存しました');
      loadNotes();
    } catch (e) {
      console.error(e);
      alert('保存に失敗しました: ' + e.message);
    }
  });

  // 一覧表示
  btnLoad.addEventListener('click', loadNotes);

  async function loadNotes() {
    notesList.innerHTML = '';
    const user = auth.currentUser;
    if (!user) {
      notesList.innerHTML = '<div class="muted">ログインすると自分のメモがここに表示されます。</div>';
      return;
    }
    try {
      const q = query(collection(db, 'notes'), where('uid', '==', user.uid), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      if (snap.empty) { notesList.innerHTML = '<div class="muted">まだメモはありません。</div>'; return; }
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'note';
        const time = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : '';
        el.innerHTML = `<div class="muted small">${time}</div><div>${escapeHtml(d.content)}</div>`;
        notesList.appendChild(el);
      });
    } catch (e) {
      console.error(e);
      notesList.innerHTML = '<div class="muted">データ取得に失敗しました</div>';
    }
  }

  // CSVエクスポート
  btnExport.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert('ログインしてください');
    try {
      const q = query(collection(db, 'notes'), where('uid', '==', user.uid), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      let csv = 'createdAt,content\n';
      snap.forEach(doc => {
        const d = doc.data();
        const ts = d.createdAt ? new Date(d.createdAt.seconds * 1000).toISOString() : '';
        const line = `${ts},"${(d.content || '').replace(/"/g, '""')}"\n`;
        csv += line;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'my_notes.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error(e);
      alert('エクスポート失敗: ' + e.message);
    }
  });

  function escapeHtml(s) { return (s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('\n', '<br/>'); }
</script>
